<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grocify</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        :root {
            --accent-pink: #E91E63;
            --accent-purple: #9C27B0;
            --primary-blue: #2196F3;
            --secondary-green: #4CAF50;
            --page-bg-start: #E3F2FD;
            --page-bg-mid: #EDE7F6;
            --page-bg-end: #E8F5E9;
            --card-bg: #FFFFFF;
            --container-bg: var(--card-bg);
            --dark-text: #333740;
            --light-text: #FFFFFF;
            --border-color: #E0E0E0;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            --border-radius: 18px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(145deg, var(--page-bg-start) 0%, var(--page-bg-mid) 50%, var(--page-bg-end) 100%);
            color: var(--dark-text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            padding: 40px 20px;
            overflow-x: hidden;
        }

        .container {
            background-color: var(--container-bg);
            padding: 45px 55px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 900px;
            text-align: center;
            animation: fadeInScaleUp 1s cubic-bezier(0.165, 0.84, 0.44, 1);
            border: 1px solid var(--border-color);
            margin-bottom: 40px;
        }

        @keyframes fadeInScaleUp {
            from { opacity: 0; transform: translateY(35px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        header { margin-bottom: 40px; }
        header h1 {
            color: var(--accent-pink);
            font-size: 4em;
            margin-bottom: 15px;
            font-weight: 700;
            letter-spacing: -3px;
            animation: headerFadeInUp 0.9s 0.2s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
            opacity: 0;
        }
        header p {
            font-size: 1.4em;
            color: var(--dark-text);
            margin-bottom: 0;
            font-weight: 400;
            animation: headerFadeInUp 0.9s 0.45s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
            opacity: 0;
        }
        @keyframes headerFadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .upload-section, .query-section, .response-section {
            background-color: var(--card-bg);
            padding: 40px;
            border-radius: var(--border-radius);
            margin-bottom: 40px;
            box-shadow: 0 7px 22px rgba(70, 70, 90, 0.09);
            animation: sectionSlideInUp 0.8s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
            opacity: 0;
            border: 1px solid var(--border-color);
        }
        @keyframes sectionSlideInUp {
            from { opacity: 0; transform: translateY(60px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .upload-section { animation-delay: 0.7s; }
        
        h2 {
            color: var(--secondary-green);
            margin-bottom: 35px;
            font-weight: 600;
            font-size: 1.9em;
            opacity: 0;
            transform: translateY(20px);
        }
        .visible h2 {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInSlideH2 0.6s 0.25s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
        }
        @keyframes fadeInSlideH2 { to { opacity: 1; transform: translateY(0); } }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 18px;
            color: var(--dark-text);
            text-align: left;
            font-size: 1.2em;
        }
        input[type="file"] { display: none; }

        .custom-file-upload {
            border: 3px dashed var(--primary-blue);
            border-radius: var(--border-radius);
            display: inline-block;
            padding: 18px 35px;
            cursor: pointer;
            background-color: #E3F2FD;
            color: var(--primary-blue);
            font-weight: 600;
            font-size: 1.1em;
            transition: all 0.25s cubic-bezier(0.165, 0.84, 0.44, 1);
            margin-bottom: 20px;
            animation: pulseButton 2.2s infinite 1.2s;
        }
        @keyframes pulseButton {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(var(--primary-blue), 0.4); }
            70% { transform: scale(1.025); box-shadow: 0 0 0 14px rgba(var(--primary-blue), 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(var(--primary-blue), 0); }
        }
        .custom-file-upload:hover, .custom-file-upload.file-selected {
            animation-play-state: paused;
            transform: scale(1.03) translateY(-3px);
            background-color: var(--primary-blue);
            color: var(--light-text);
            border-color: var(--primary-blue);
        }
        #fileName {
            margin-top: 20px;
            font-style: italic;
            color: var(--dark-text);
            font-size: 1.05em;
        }
        #pdfStatus {
            margin-top: 18px;
            font-weight: 500;
            height: 30px;
            font-size: 1.15em;
        }
        #pdfStatusIcon { margin-right: 10px; font-size: 1.3em; }

        textarea, input[type="text"] {
            width: 100%;
            padding: 20px;
            margin-bottom: 28px;
            border: 1.5px solid var(--border-color);
            border-radius: var(--border-radius);
            font-family: 'Poppins', sans-serif;
            font-size: 1.1em;
            resize: vertical;
            transition: border-color 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
            background-color: #FAFAFC;
        }
        textarea:focus, input[type="text"]:focus {
            border-color: var(--accent-pink);
            outline: none;
            box-shadow: 0 0 0 4px rgba(233, 30, 99, 0.25);
            background-color: var(--card-bg);
        }

        button#submitQuery {
            background: linear-gradient(60deg, var(--accent-pink), var(--accent-purple));
            color: white;
            padding: 20px 40px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1.2em;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
            box-shadow: 0 5px 12px rgba(156, 39, 176, 0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        button#submitQuery:hover:not(:disabled) {
            transform: translateY(-6px) scale(1.03);
            box-shadow: 0 8px 20px rgba(233, 30, 99, 0.4);
        }
        button#submitQuery:disabled {
            background: linear-gradient(60deg, #D1C4E9, #CFD8DC);
            color: #78909C;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        #responseArea {
            background-color: #F8F9FE;
            padding: 35px;
            border-radius: var(--border-radius);
            text-align: left;
            min-height: 160px;
            border: 1px solid var(--border-color);
            animation: resultContainerFadeIn 0.7s cubic-bezier(0.165, 0.84, 0.44, 1);
            white-space: pre-wrap;
            line-height: 1.85;
            transition: opacity 0.4s ease-in-out;
        }
        @keyframes resultContainerFadeIn {
            from { opacity: 0; transform: translateY(25px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #responseArea > p:first-child {
            font-size: 1.15em;
            font-weight: 500;
            color: var(--primary-blue);
            margin-bottom: 25px;
        }
        #responseArea ul { list-style-type: none; padding-left: 0; }
        #responseArea li:not(.suggestion) {
            background-color: var(--card-bg);
            border-left: 7px solid var(--accent-purple);
            padding: 22px 28px;
            margin-bottom: 20px;
            border-radius: 14px;
            box-shadow: 0 5px 10px rgba(70, 70, 90, 0.07);
            transition: transform 0.25s ease-out, box-shadow 0.25s ease-out;
            opacity: 0;
            transform: scale(0.95) translateY(10px);
            animation: popInListItem 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        #responseArea li:not(.suggestion):nth-child(1) { animation-delay: 0.1s; }
        #responseArea li:not(.suggestion):nth-child(2) { animation-delay: 0.18s; }
        #responseArea li:not(.suggestion):nth-child(3) { animation-delay: 0.26s; }
        #responseArea li:not(.suggestion):nth-child(4) { animation-delay: 0.34s; }
        #responseArea li:not(.suggestion):nth-child(5) { animation-delay: 0.42s; }
        @keyframes popInListItem { to { opacity: 1; transform: scale(1) translateY(0); } }
        #responseArea li:not(.suggestion):hover {
            transform: translateX(10px) scale(1.02);
            box-shadow: 0 7px 15px rgba(70, 70, 90, 0.12);
        }
        #responseArea .info-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        #responseArea .info-item:last-child { margin-bottom: 0; }
        #responseArea .info-item .icon {
            margin-right: 12px;
            color: var(--primary-blue);
            font-size: 1.25em;
            display: inline-block;
            opacity: 0;
            transform: scale(0.5) rotate(-15deg);
            animation: popInIcon 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            width: 28px;
            text-align: center;
        }
        #responseArea li:not(.suggestion) .info-item:nth-of-type(1) .icon { animation-delay: 0.3s; }
        #responseArea li:not(.suggestion) .info-item:nth-of-type(2) .icon { animation-delay: 0.38s; }
        #responseArea li:not(.suggestion) .info-item:nth-of-type(3) .icon { animation-delay: 0.46s; }
        #responseArea li:not(.suggestion) .info-item:nth-of-type(4) .icon { animation-delay: 0.54s; }
        #responseArea li:not(.suggestion) .info-item:nth-of-type(5) .icon { animation-delay: 0.62s; }
        #responseArea li:not(.suggestion) .info-item:nth-of-type(6) .icon { animation-delay: 0.70s; }
        @keyframes popInIcon { to { opacity: 1; transform: scale(1) rotate(0deg); } }
        #responseArea .info-item .deal-text { color: var(--accent-pink); font-weight: 600; }
        #responseArea .info-item strong { color: var(--dark-text); font-weight: 500; margin-right: 6px; }

        #responseArea .suggestion {
            background-color: #F3E5F5;
            border-left: 7px solid var(--accent-purple);
            color: var(--dark-text);
            padding: 20px 28px;
            margin-bottom: 18px;
            border-radius: 14px;
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInSuggestion 0.6s 0.5s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
            font-size: 1.1em;
        }
        @keyframes fadeInSuggestion { to { opacity: 1; transform: translateY(0); } }
        #responseArea .suggestion strong { color: var(--accent-purple); }

        #responseArea .no-results {
            color: var(--accent-pink);
            font-weight: 500;
            text-align: center;
            padding: 40px 30px;
            background-color: #FCE4EC;
            border-radius: var(--border-radius);
            font-size: 1.2em;
            opacity: 0;
            animation: fadeInNoResults 0.6s ease-out forwards;
            border: 2px dashed var(--accent-pink);
        }
        @keyframes fadeInNoResults { to { opacity: 1; } }

        .loader {
            border: 8px solid #E8EAF6;
            border-top: 8px solid var(--accent-pink);
            border-radius: 50%;
            width: 55px;
            height: 55px;
            animation: spin 0.8s linear infinite;
            margin: 40px auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .query-section, .response-section { display: none; opacity: 0; }
        .query-section.visible, .response-section.visible {
            display: block;
            opacity: 1;
            animation: sectionSlideInUp 0.8s cubic-bezier(0.165, 0.84, 0.44, 1) forwards;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Grocify</h1>
            <p>Hello, I am Grocee. Let's fresh fetch!</p>
        </header>

        <section class="upload-section">
            <h2>1. Upload Your E-Groceries PDF</h2>
            <label for="pdfFile" class="custom-file-upload">✨ Choose PDF File ✨</label>
            <input type="file" id="pdfFile" accept=".pdf">
            <p id="fileName">No file selected.</p>
            <p id="pdfStatus">
                <span id="pdfStatusIcon"></span><span id="pdfStatusText"></span>
            </p>
        </section>

        <section class="query-section" id="querySection">
            <h2>2. Ask Grocee</h2>
            <label for="userQuery">Enter your query (e.g., "best deal on apples", "fastest delivery for milk"): </label>
            <textarea id="userQuery" rows="4" placeholder="What are you looking for today? 🥕🍓🍞"></textarea>
            <button id="submitQuery" disabled>Fetch Groceries Info</button>
        </section>

        <section class="response-section" id="responseSection">
            <h2>3. Grocee's Insights</h2>
            <div class="loader" id="loader"></div>
            <div id="responseArea">
                Awaiting your query...
            </div>
        </section>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.9.359/pdf.worker.min.js';

        const pdfFileInput = document.getElementById('pdfFile');
        const fileNameDisplay = document.getElementById('fileName');
        const pdfStatusDisplay = document.getElementById('pdfStatus');
        const pdfStatusIcon = document.getElementById('pdfStatusIcon');
        const pdfStatusText = document.getElementById('pdfStatusText');
        const querySection = document.getElementById('querySection');
        const userQueryInput = document.getElementById('userQuery');
        const submitQueryButton = document.getElementById('submitQuery');
        const responseSection = document.getElementById('responseSection');
        const responseArea = document.getElementById('responseArea');
        const loader = document.getElementById('loader');
        const customFileUploadButton = document.querySelector('.custom-file-upload');

        let pdfTextData = []; 

        pdfFileInput.addEventListener('change', handlePdfUpload);

        function showSection(sectionElement) {
            sectionElement.style.display = 'block'; 
            setTimeout(() => {
                 sectionElement.classList.add('visible');
            }, 10); 
        }
        function hideSection(sectionElement) {
            sectionElement.classList.remove('visible');
            setTimeout(() => { 
                if (!sectionElement.classList.contains('visible')) {
                    sectionElement.style.display = 'none';
                }
            }, 800); 
        }

        function handlePdfUpload(event) {
            const file = event.target.files[0];
            pdfTextData = [];
            
            hideSection(querySection);
            hideSection(responseSection);

            submitQueryButton.disabled = true;
            responseArea.innerHTML = "Awaiting your query...";

            if (file && file.type === "application/pdf") {
                fileNameDisplay.textContent = `Selected: ${file.name}`;
                customFileUploadButton.classList.add('file-selected'); 
                pdfStatusIcon.textContent = "⏳";
                pdfStatusText.textContent = "Processing PDF...";
                pdfStatusDisplay.style.color = "var(--primary-blue)"; 
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const typedarray = new Uint8Array(e.target.result);
                    pdfjsLib.getDocument({data: typedarray}).promise.then(pdf => {
                        const numPages = pdf.numPages;
                        let pagePromises = [];

                        for (let i = 1; i <= numPages; i++) {
                            pagePromises.push(
                                pdf.getPage(i).then(page => {
                                    return page.getTextContent().then(textContent => {
                                        let linesFromPage = [];
                                        let currentLine = "";
                                        let lastY = -1;
                                        const Y_TOLERANCE = 5; 

                                        let sortedItems = textContent.items.slice().sort((a,b) => {
                                            if (Math.abs(a.transform[5] - b.transform[5]) > Y_TOLERANCE) {
                                                return a.transform[5] - b.transform[5];
                                            }
                                            return a.transform[4] - b.transform[4];
                                        });
                                        
                                        sortedItems.forEach(item => {
                                            if (lastY !== -1 && Math.abs(item.transform[5] - lastY) > Y_TOLERANCE) {
                                                linesFromPage.push(currentLine.trim());
                                                currentLine = "";
                                            }
                                            currentLine += (item.str || '') + " ";
                                            lastY = item.transform[5];
                                        });
                                        if (currentLine.trim() !== "") {
                                            linesFromPage.push(currentLine.trim());
                                        }
                                        
                                        if (linesFromPage.length < 5) { 
                                            console.warn("Y-coordinate line reconstruction produced few lines, falling back to pageText split.")
                                            const pageStr = textContent.items.map(item => item.str || '').join(' ');
                                            linesFromPage = pageStr.split(/\r\n|\r|\n/).map(line => line.trim()).filter(line => line.length > 10);
                                        }
                                        return linesFromPage.filter(line => line.length > 10); 
                                    });
                                })
                            );
                        }
                        return Promise.all(pagePromises);
                    }).then(pagesTextArrays => {
                        pagesTextArrays.forEach(pageLines => {
                            pdfTextData.push(...pageLines);
                        });
                        
                        if (pdfTextData.length > 0) {
                            pdfStatusIcon.textContent = "✅";
                            pdfStatusText.textContent = "PDF processed! You can now ask Grocee.";
                            pdfStatusDisplay.style.color = "var(--secondary-green)";
                            showSection(querySection);
                            showSection(responseSection);
                            submitQueryButton.disabled = false;
                            responseArea.innerHTML = "PDF data loaded. Ready for your query!";
                        } else {
                            pdfStatusIcon.textContent = "⚠️";
                            pdfStatusText.textContent = "PDF processed, but no usable text found. Try a different PDF.";
                            pdfStatusDisplay.style.color = "var(--accent-pink)"; 
                            fileNameDisplay.textContent = "No file selected.";
                            customFileUploadButton.classList.remove('file-selected');
                        }
                    }).catch(error => {
                        console.error("Error processing PDF:", error);
                        pdfStatusIcon.textContent = "❌";
                        pdfStatusText.textContent = "Error processing PDF. Please try another file.";
                        pdfStatusDisplay.style.color = "var(--accent-pink)"; 
                        fileNameDisplay.textContent = "No file selected.";
                        customFileUploadButton.classList.remove('file-selected');
                    });
                };
                reader.readAsArrayBuffer(file);
            } else {
                fileNameDisplay.textContent = "No file selected or invalid file type (PDF only).";
                customFileUploadButton.classList.remove('file-selected');
                pdfStatusIcon.textContent = "";
                pdfStatusText.textContent = "";
            }
        }

        submitQueryButton.addEventListener('click', handleQuerySubmit);
        userQueryInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); 
                if (!submitQueryButton.disabled) handleQuerySubmit();
            }
        });

        function handleQuerySubmit() {
            const query = userQueryInput.value.trim();
            if (!query) {
                responseArea.style.opacity = 0;
                setTimeout(() => {
                    responseArea.innerHTML = "<p class='no-results'>Please enter a query.</p>";
                    responseArea.style.opacity = 1;
                }, 300);
                return;
            }
            if (pdfTextData.length === 0) {
                 responseArea.style.opacity = 0;
                setTimeout(() => {
                    responseArea.innerHTML = "<p class='no-results'>Please upload and process a PDF first.</p>";
                    responseArea.style.opacity = 1;
                }, 300);
                return;
            }

            loader.style.display = 'block';
            responseArea.style.opacity = 0; 
            submitQueryButton.disabled = true;

            setTimeout(() => { 
                const results = searchPdfData(query);
                displayResults(results, query); 
                loader.style.display = 'none';
                submitQueryButton.disabled = false; 
            }, 1200); 
        }

        function parseDeliveryTimeToMinutes(deliveryTimeStr) {
            if (!deliveryTimeStr || typeof deliveryTimeStr !== 'string') return Infinity;
            const lowerStr = deliveryTimeStr.toLowerCase();
            const minMatch = lowerStr.match(/(\d+)\s*mins?(?:utes)?/);
            if (minMatch) {
                return parseInt(minMatch[1], 10);
            }
            const hourMatchGeneral = lowerStr.match(/(\d+)\s*hour/);
            if (hourMatchGeneral) {
                return parseInt(hourMatchGeneral[1], 10) * 60;
            }
            if (lowerStr.includes("same day")) { 
                return 24 * 60; 
            }
            return Infinity; 
        }

        function isCommonQueryWord(word) {
            const commonWords = new Set([
                'for', 'the', 'and', 'a', 'is', 'of', 'find', 'get', 'show', 'me', 'best', 
                'cheapest', 'fastest', 'delivery', 'deal', 'deals', 'offer', 'offers', 'on', 
                'in', 'what', 'where', 'how', 'much', 'buy', 'item', 'product', 'price', 'cost', 
                'discount', 'brand', 'available', 'provide', 'tell', 'about', 'any', 'search', 'top'
            ]);
            return commonWords.has(word.toLowerCase());
        }

        function searchPdfData(query) {
            const lowerQuery = query.toLowerCase();
            let results = []; 

            const fastestDeliveryPattern = /fastest delivery for\s+(.+)/i; 
            const itemFastestPattern = /(.+)\s+fastest delivery/i;       
            const bestDealPattern = /(?:best|any|find|search|show me|top)\s+(?:deal|deals|offer|offers)\s+(?:on|for)\s+(.+)/i; 
            const itemBestDealPattern = /(.+)\s+(?:best|any|find|search|show me|top)\s+(?:deal|deals|offer|offers)/i;

            let targetItemName = null;
            let searchMode = "general"; 

            let match;
            if ((match = lowerQuery.match(fastestDeliveryPattern)) || (match = lowerQuery.match(itemFastestPattern))) {
                targetItemName = match[1].trim();
                searchMode = "fastest_for_item";
            } 
            else if ((match = lowerQuery.match(bestDealPattern)) || (match = lowerQuery.match(itemBestDealPattern))) {
                targetItemName = match[1].trim();
                searchMode = "best_deal_for_item";
            }

            if (searchMode === "fastest_for_item" && targetItemName) {
                console.log(`Searching for FASTEST DELIVERY for item: "${targetItemName}"`);
                let itemEntries = [];
                let targetItemTerms = targetItemName.toLowerCase().split(/\s+/).filter(t => t.length > 0 && !isCommonQueryWord(t));
                if (targetItemTerms.length === 0 && targetItemName.length > 0) { 
                    targetItemTerms = targetItemName.toLowerCase().split(/\s+/).filter(t => t.length > 0);
                }

                if (targetItemTerms.length > 0) {
                    pdfTextData.forEach(line => {
                        const info = extractInfo(line);
                        const currentItemText = ((info.item && info.item !== "N/A" ? info.item.toLowerCase() : "") + 
                                                 (info.brand && info.brand !== "N/A" ? " " + info.brand.toLowerCase() : "")).trim();

                        if (targetItemTerms.every(term => currentItemText.includes(term))) {
                            const deliveryMinutes = parseDeliveryTimeToMinutes(info.deliveryTime);
                            itemEntries.push({ line: line, deliveryMinutes: deliveryMinutes, fullInfo: info });
                        }
                    });
                    itemEntries.sort((a, b) => a.deliveryMinutes - b.deliveryMinutes);
                    results = itemEntries;
                }
            } else if (searchMode === "best_deal_for_item" && targetItemName) {
                console.log(`Searching for BEST DEAL for item: "${targetItemName}" (Strict: item must have a deal)`);
                let itemEntriesWithDeals = [];
                let targetItemTerms = targetItemName.toLowerCase().split(/\s+/).filter(t => t.length > 0 && !isCommonQueryWord(t));
                 if (targetItemTerms.length === 0 && targetItemName.length > 0) { 
                    targetItemTerms = targetItemName.toLowerCase().split(/\s+/).filter(t => t.length > 0);
                }

                if (targetItemTerms.length > 0) {
                    pdfTextData.forEach(line => {
                        const info = extractInfo(line);
                        const currentItemText = ((info.item && info.item !== "N/A" ? info.item.toLowerCase() : "") + 
                                                 (info.brand && info.brand !== "N/A" ? " " + info.brand.toLowerCase() : "")).trim();
                        
                        if (targetItemTerms.every(term => currentItemText.includes(term))) {
                            if (info.deals && typeof info.deals === 'string' &&
                                info.deals.toLowerCase() !== "no specific deals mentioned" && 
                                info.deals.toLowerCase() !== "no current deal" &&
                                info.deals.toLowerCase() !== "n/a") {
                                itemEntriesWithDeals.push({ line: line, score: 1, fullInfo: info }); 
                            }
                        }
                    });
                    itemEntriesWithDeals.sort((a, b) => b.score - a.score); 
                    results = itemEntriesWithDeals; 
                }
            } else { 
                console.log(`Performing GENERAL search for query: "${lowerQuery}"`);
                const queryTerms = lowerQuery.split(/\s+/).filter(term => term.length > 1 && !isCommonQueryWord(term));
                const searchTermsToUse = queryTerms.length > 0 ? queryTerms : lowerQuery.split(/\s+/).filter(term => term.length > 1);

                if (searchTermsToUse.length > 0) {
                    pdfTextData.forEach(line => {
                        const info = extractInfo(line);
                        const lowerLineText = line.toLowerCase(); 
                        let matchCount = 0;

                        searchTermsToUse.forEach(term => {
                            if (lowerLineText.includes(term)) {
                                matchCount++;
                                if (info.item && info.item !== "N/A" && info.item.toLowerCase().includes(term)) matchCount += 2;
                                if (info.brand && info.brand !== "N/A" && info.brand.toLowerCase().includes(term)) matchCount += 2;
                                if (info.platform && info.platform !== "N/A" && info.platform.toLowerCase().includes(term)) matchCount +=1;
                            }
                        });
                        
                        if (lowerQuery.includes("fastest delivery")) {
                            const deliveryMinutes = parseDeliveryTimeToMinutes(info.deliveryTime);
                            if (deliveryMinutes < 30) matchCount += 1; 
                            else if (deliveryMinutes < 60) matchCount += 0.5;
                        }
                        if (lowerQuery.includes("best deal") || lowerQuery.includes("offer")) {
                            if (info.deals && typeof info.deals === 'string' &&
                                info.deals.toLowerCase() !== "no specific deals mentioned" &&
                                info.deals.toLowerCase() !== "no current deal" &&
                                info.deals.toLowerCase() !== "n/a") {
                                matchCount +=1;
                            }
                        }

                        if (matchCount > 0) {
                            results.push({ line: line, score: matchCount, fullInfo: info });
                        }
                    });
                    results.sort((a, b) => b.score - a.score);
                }
            }
            return results.slice(0, 10);
        }
        
        function isCommonGroceryWordOrUnit(word) { // This function seems unused in current search logic, but kept from original
            if (!word) return true; 
            const lowerWord = word.toLowerCase();
            const commonWords = new Set([
                'fresh', 'organic', 'natural', 'pure', 'select', 'premium', 'value', 'choice', 'best', 'good', 'fine', 'superfine', 'extra',
                'whole', 'sliced', 'diced', 'frozen', 'chilled', 'refined', 'double', 'triple', 'rich', 'cream', 'original', 'classic', 'light', 'lite',
                'pack', 'combo', 'offer', 'deal', 'save', 'free', 'new', 'super', 'family', 'economy', 'budget', 'regular', 'valuepack',
                'gm', 'gr', 'g', 'kg', 'ml', 'ltr', 'liter', 'litre', 'gram', 'kilo', 'piece', 'pcs', 'pc', 'unit', 'units', 'bottle', 'tin', 'can', 'box', 'jar', 'pouch', 'sachet', 'pkt',
                'atta', 'rice', 'dal', 'sugar', 'salt', 'oil', 'milk', 'bread', 'butter', 'cheese', 'eggs', 'ghee', 'curd', 'yogurt', 'paneer',
                'tea', 'coffee', 'juice', 'water', 'biscuit', 'noodle', 'pasta', 'sauce', 'jam', 'ketchup', 'pickle', 'chips', 'snack', 'namkeen', 'chocolate', 'candy',
                'soap', 'shampoo', 'powder', 'liquid', 'gel', 'spray', 'bar', 'wash', 'cleaner', 'hygiene', 'disinfectant', 'detergent', 'conditioner',
                'red', 'green', 'yellow', 'white', 'brown', 'black', 'orange', 'blue', 'pink', 'golden', 'silver',
                'maida', 'besan', 'sooji', 'poha', 'rawa', 'masoor', 'moong', 'chana', 'rajma', 'toor', 'urad',
                'vegetable', 'fruit', 'spice', 'masala', 'herb', 'nuts', 'dry', 'pulses', 'cereals', 'grain', 'seed', 'flour',
                'a', 'an', 'the', 'is', 'of', 'for', 'with', 'by', 'and', 'or', 'in', 'on', 'at', 'to', 'from', 'all', 'every', 'some', 'each', 'per', 'any', 'my', 'your', 'our',
                'company', 'pvt', 'ltd', 'limited', 'corp', 'corporation', 'inc', 'incorporated', 'sons', '&', 'co', 
                'blinkit', 'bigbasket', 'instamart', 'zepto', 'swiggy', 'dunzo', 'grofers', 'amazon', 'flipkart', 'jiomart', 
                'price', 'mrp', 'cost', 'delivery', 'time', 'available', 'stock', 'off', 'discount', 'rs', 'inr', 
                'item', 'product', 'brand', 'quality', 'size', 'type', 'flavour', 'variant', 'range', 'collection', 'edition', 'style', 
                'get', 'buy', 'shop', 'order', 'add', 'cart', 'view', 'details', 'search', 'find', 
                'no', 'dr', 'mr', 'mrs', 'ms' 
            ]);
            if (/^\d+$/.test(lowerWord) || /^\d+g$/i.test(lowerWord) || /^\d+kg$/i.test(lowerWord) || /^\d+ml$/i.test(lowerWord) || /^\d+l$/i.test(lowerWord)) return true; 
            if (lowerWord.length <= 2 && !['pc', 'gm', 'kg', 'ml', 'rs', 'dr', 'mr', 'no', 'oz', 'lb'].includes(lowerWord)) return true; 
            return commonWords.has(lowerWord);
        }
        
        function extractInfo(line) {
            let info = {
                platform: "N/A", item: "N/A", brand: "N/A", cost: "N/A",
                deals: "N/A", deliveryTime: "N/A"
            };
            
            let processedLine = line.trim();

            const deliveryTimeRegex = /(\d+\s*mins?(?:utes)?|Same Day\s*\(?\s*\d+\s*hour\s*\)?)$/i;
            const deliveryMatch = processedLine.match(deliveryTimeRegex);
            if (deliveryMatch) {
                info.deliveryTime = deliveryMatch[0].trim();
                processedLine = processedLine.substring(0, processedLine.lastIndexOf(deliveryMatch[0])).trim();
            }

            let words = processedLine.split(/\s+/).filter(w => w.length > 0);
            let costIndex = -1;

            for (let i = words.length - 1; i >= 0; i--) {
                if (/^\d+$/.test(words[i])) {
                    if (!((words[i-1] && words[i-1].toLowerCase() === "buy") || (words[i-1] && words[i-1].toLowerCase() === "get")) ) {
                         costIndex = i;
                         break;
                    }
                }
            }

            if (costIndex !== -1 && costIndex > 0) { 
                info.cost = `₹${words[costIndex]}`;
                if (costIndex < words.length - 1) {
                    info.deals = words.slice(costIndex + 1).join(" ").trim();
                    if (info.deals === "") info.deals = "N/A";
                } else {
                    info.deals = "N/A"; 
                }
                processedLine = words.slice(0, costIndex).join(" ").trim(); 
            }

            const categories = ["Groceries", "Essentials", "Miscellan."]; 
            for (const cat of categories) {
                if (processedLine.toLowerCase().startsWith(cat.toLowerCase())) {
                    processedLine = processedLine.substring(cat.length).trim();
                    break;
                }
            }

            const platforms = ["Blinkit", "Instamart", "Zepto", "Big Basket", "Flipkart"];
            for (const p of platforms) {
                const pLower = p.toLowerCase();
                if (processedLine.toLowerCase().startsWith(pLower)) {
                    info.platform = p; 
                    processedLine = processedLine.substring(p.length).trim();
                    break; 
                }
            }
            
            words = processedLine.split(/\s+/).filter(w => w.length > 0);
            if (words.length > 0) {
                const numWords = words.length;
                const twoWordBrands = [ 
                    "mother diary", "english oven", "tata tea", "nescafe classic", 
                    "table eggs", "tata gold", "24 mantra", "surf excel", "head&shoulder", "dr. hen", "nutri choice"
                ];
                if (numWords >= 2 && twoWordBrands.includes((words[numWords-2] + " " + words[numWords-1]).toLowerCase())) {
                    info.brand = words[numWords-2] + " " + words[numWords-1]; 
                    info.item = words.slice(0, numWords-2).join(" ");
                } else if (numWords >= 1) { 
                    info.brand = words[numWords-1];
                    info.item = words.slice(0, numWords-1).join(" ");
                }
                
                if (info.item === "" && info.brand !== "N/A") { 
                     info.item = "N/A";
                }
                 if (info.item === "" && info.brand === "N/A" && words.length > 0){ 
                    info.item = words.join(" "); 
                }
                if(info.item === "" && info.brand === "" && words.length > 0) { // If both are empty strings
                    info.item = words.join(" ");
                    info.brand = "N/A";
                }
                 if(info.item === "N/A" && info.brand === "N/A" && words.length > 0) {
                    info.item = words.join(" ");
                }


            } else { 
                info.item = "N/A";
                info.brand = "N/A";
            }

            const titleCase = (str) => {
                if (!str || str === "N/A" || typeof str !== 'string') return str;
                return str.toLowerCase().split(' ').map(word => {
                    if (word.length > 0) return word.charAt(0).toUpperCase() + word.slice(1);
                    return "";
                }).join(' ');
            };

            info.item = titleCase(info.item);
            info.brand = titleCase(info.brand);
            
            if (info.deals && typeof info.deals === 'string' && info.deals.toLowerCase().includes("no current deal")) {
                info.deals = "No current deal";
            }
            if (info.deals === "N/A" && info.cost !== "N/A" && info.deals !== "No current deal") info.deals = "No current deal";

            return info;
        }

        function displayResults(resultsWithScore, query) {
            let htmlOutput = ""; 

            if (!resultsWithScore || resultsWithScore.length === 0) {
                htmlOutput = `<p class="no-results">🌶️ Oops! Grocee couldn't find anything matching "<strong>${query}</strong>". <br>Try a different search or ensure your PDF has the info!</p>`;
            } else {
                htmlOutput = `<p>Here's what Grocee fetched for "<strong>${query}</strong>":</p>`;
                htmlOutput += "<ul>";
                
                let foundItemsForSuggestions = [];

                resultsWithScore.forEach(resultItem => {
                    const info = resultItem.fullInfo || extractInfo(resultItem.line); 
                    foundItemsForSuggestions.push(info);

                    htmlOutput += `<li>`;
                    htmlOutput += `<div class="info-item"><span class="icon">🛒</span><strong>Item:</strong> ${info.item || 'N/A'}</div>`;
                    htmlOutput += `<div class="info-item"><span class="icon">🏭</span><strong>Brand:</strong> ${info.brand || 'N/A'}</div>`;
                    htmlOutput += `<div class="info-item"><span class="icon">🏪</span><strong>Platform:</strong> ${info.platform || 'N/A'}</div>`;
                    htmlOutput += `<div class="info-item"><span class="icon">💰</span><strong>Cost:</strong> ${info.cost || 'N/A'}</div>`;
                    htmlOutput += `<div class="info-item"><span class="icon">🏷️</span><strong>Deals:</strong> <span class="deal-text">${info.deals || 'N/A'}</span></div>`;
                    htmlOutput += `<div class="info-item"><span class="icon">⏱️</span><strong>Avg. Delivery:</strong> ${info.deliveryTime || 'N/A'}</div>`;
                    htmlOutput += `</li>`;
                });
                htmlOutput += "</ul>";

                let suggestions = [];
                let minDeliveryTime = Infinity;
                let fastestPlatform = "";
                let fastestItemDetails = null; 
                let dealsCount = 0;
                let itemsWithDeals = [];

                foundItemsForSuggestions.forEach(info => {
                    if (info.deliveryTime !== "N/A" && typeof info.deliveryTime === 'string') {
                        const deliveryMinutes = parseDeliveryTimeToMinutes(info.deliveryTime);
                        if (deliveryMinutes < minDeliveryTime) {
                            minDeliveryTime = deliveryMinutes;
                            fastestPlatform = info.platform !== "N/A" ? info.platform : "N/A";
                            fastestItemDetails = info; 
                        }
                    }
                    if (info.deals && typeof info.deals === 'string' && 
                        info.deals.toLowerCase() !== "no specific deals mentioned" && 
                        info.deals.toLowerCase() !== "no current deal" &&
                        info.deals.toLowerCase() !== "n/a" ) {
                        dealsCount++;
                        if (info.item && info.item !== "N/A (Check context)" && info.item !== "N/A" && !itemsWithDeals.includes(info.item)) {
                            itemsWithDeals.push(info.item);
                        }
                    }
                });

                const queryLower = query.toLowerCase();
                if ((queryLower.includes("fastest delivery for") || queryLower.endsWith("fastest delivery")) && fastestItemDetails && fastestItemDetails.item !== "N/A") {
                     suggestions.push(`🚀 The fastest option found for items matching your query is ~<strong>${fastestItemDetails.deliveryTime}</strong> via <strong>${fastestItemDetails.platform}</strong> (for ${fastestItemDetails.item} - ${fastestItemDetails.brand}).`);
                } else if (fastestPlatform && minDeliveryTime !== Infinity && fastestPlatform !== "N/A") { 
                    suggestions.push(`🚀 For potentially faster delivery among these results, <strong>${fastestPlatform}</strong> has an option around ${minDeliveryTime} min.`);
                }

                if (dealsCount > 0) {
                    let dealSuggestion = `🎉 Grocee found <strong>${dealsCount} result(s) with potential deals!</strong>`;
                    if (itemsWithDeals.length > 0 && itemsWithDeals.length <=3) {
                        dealSuggestion += ` Check out offers for: ${itemsWithDeals.join(', ')}.`;
                    } else if (itemsWithDeals.length > 3) {
                        dealSuggestion += ` Check out offers for items like ${itemsWithDeals.slice(0,2).join(', ')} and more.`;
                    }
                    suggestions.push(dealSuggestion);
                }
                if (resultsWithScore.length > 3 && resultsWithScore.length < 10) {
                    suggestions.push(`🔍 Found ${resultsWithScore.length} relevant entries. You can refine your query for more specific results if needed.`);
                }
                if (suggestions.length === 0 && resultsWithScore.length > 0) { 
                    suggestions.push("💡 Remember to compare options across different platforms if available in the data!");
                }

                if (suggestions.length > 0) {
                    htmlOutput += "<p style='margin-top: 25px;'><strong>Grocee's Quick Suggestions:</strong></p><ul>";
                    suggestions.forEach(sugg => {
                        htmlOutput += `<li class="suggestion">${sugg}</li>`;
                    });
                    htmlOutput += "</ul>";
                }
            }
            
            responseArea.innerHTML = htmlOutput; 
            responseArea.style.opacity = 1; 
        }
    </script>
</body>
</html>